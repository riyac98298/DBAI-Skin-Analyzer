{% extends "base.html" %}
{% block content %}

<!-- Pass values to JS via data-* -->
<section class="rounded-2xl border bg-white p-6 shadow-sm space-y-6"
         data-aeye-result
         data-img="{{ url_for('static', filename='uploads/' + analyzed_filename) }}"
         data-dark="{{ prob_dark_circles if prob_dark_circles is not none else 0 }}"
         data-acne="{{ prob_acne if prob_acne is not none else 0 }}">
  <h2 class="text-lg font-semibold">Analysis Results</h2>

  <!-- Top toolbar: CTAs + Save/Track -->
  <div class="flex flex-wrap items-center gap-3">
    <a href="#" class="inline-flex items-center rounded-xl bg-brand px-4 py-2 font-medium text-white hover:bg-brand-dark">
      Buy this routine
    </a>
    <a href="#" class="inline-flex items-center rounded-xl border px-4 py-2 font-medium hover:bg-gray-50">
      Talk to a dermatologist
    </a>

    <div class="ml-auto flex items-center gap-2">
      <label for="save-track" class="text-sm font-medium">Save & track my skin</label>
      <!-- pretty switch -->
      <label class="relative inline-flex cursor-pointer items-center">
        <input id="save-track" type="checkbox" class="peer sr-only">
        <div class="h-6 w-11 rounded-full bg-gray-300 transition-colors peer-checked:bg-brand"></div>
        <div class="absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white transition-transform peer-checked:translate-x-5"></div>
      </label>
    </div>
  </div>

  <!-- Compare block (auto-fills when there is a previous saved run) -->
  <div id="compare-block" class="hidden rounded-xl border p-4">
    <h3 class="mb-3 text-sm font-semibold text-gray-700">Before vs After</h3>
    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <div class="mb-2 text-xs text-gray-500" id="compare-prev-meta"></div>
        <img id="compare-prev-img" class="w-full rounded-lg ring-1 ring-gray-200 object-cover" alt="Previous" />
      </div>
      <div>
        <div class="mb-2 text-xs text-gray-500">Now</div>
        <img src="{{ url_for('static', filename='uploads/' + analyzed_filename) }}"
             class="w-full rounded-lg ring-1 ring-gray-200 object-cover" alt="Current" />
      </div>
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid gap-6 md:grid-cols-2">
    <!-- Annotated image -->
    <div>
      <img src="{{ url_for('static', filename='uploads/' + analyzed_filename) }}"
           alt="Analyzed" class="w-full rounded-xl ring-1 ring-gray-200" />
    </div>

    <!-- Scores & recommendations -->
    <div class="space-y-6">
      <!-- Detected issues -->
      <div>
        <h3 class="mb-2 text-sm font-semibold text-gray-700">Detected issues</h3>
        <ul class="space-y-2 text-sm">
          {% if prob_dark_circles is not none %}
          <li class="flex items-center gap-3">
            <span class="inline-flex items-center rounded-full bg-indigo-50 px-2 py-0.5 text-indigo-700">Dark circles</span>
            <div class="h-2 w-40 rounded bg-gray-200"><div class="h-2 rounded bg-indigo-500" style="width: {{ (prob_dark_circles*100)|round(0) }}%"></div></div>
            <span class="w-12 text-right">{{ (prob_dark_circles*100)|round(1) }}%</span>
          </li>
          {% endif %}
          {% if prob_acne is not none %}
          <li class="flex items-center gap-3">
            <span class="inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-rose-700">Acne</span>
            <div class="h-2 w-40 rounded bg-gray-200"><div class="h-2 rounded bg-rose-500" style="width: {{ (prob_acne*100)|round(0) }}%"></div></div>
            <span class="w-12 text-right">{{ (prob_acne*100)|round(1) }}%</span>
          </li>
          {% endif %}
        </ul>
      </div>

      <!-- Why we recommended this (accordion) -->
      <details class="rounded-xl border p-4 open:shadow-sm">
        <summary class="cursor-pointer select-none text-sm font-semibold">
          Why we recommended this
        </summary>
        <div class="mt-3 text-sm leading-6 text-gray-700 space-y-2">
          {% if prob_dark_circles is not none and prob_dark_circles > 0.3 %}
            <p><strong>Dark circles:</strong> Your photo shows under-eye darkness ({{ (prob_dark_circles*100)|round(0) }}% confidence). We highlight brightening actives like Vitamin C for tone and caffeine/niacinamide for puffiness.</p>
          {% endif %}
          {% if prob_acne is not none and prob_acne > 0.3 %}
            <p><strong>Acne:</strong> We detected acne-like spots ({{ (prob_acne*100)|round(0) }}% confidence). We suggest gentle chemical exfoliation (e.g., 2% salicylic acid) to unclog pores and reduce new breakouts.</p>
          {% endif %}
          <p><em>Note:</em> This is a classroom demo and not medical advice. Always patch-test new products.</p>
        </div>
      </details>

      <!-- Recommended products -->
      <div>
        <h3 class="mb-2 text-sm font-semibold text-gray-700">Recommended products</h3>
        <div class="space-y-3">
          {% for card in recommendations %}
          <div class="flex gap-3 rounded-xl border p-4">
            {% set t = card.title|lower %}
            {% if 'vitamin c' in t %}
              <svg class="mt-1 h-6 w-6 text-amber-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 017 7c0 4.97-7 13-7 13S5 13.97 5 9a7 7 0 017-7zm0 9.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/></svg>
            {% elif 'salicylic' in t or 'bha' in t %}
              <svg class="mt-1 h-6 w-6 text-emerald-500" viewBox="0 0 24 24" fill="currentColor"><path d="M4 12a8 8 0 1116 0 8 8 0 01-16 0zm5-1h6v2H9z"/></svg>
            {% elif 'sunscreen' in t or 'spf' in t %}
              <svg class="mt-1 h-6 w-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 18a6 6 0 100-12 6 6 0 000 12z"/></svg>
            {% else %}
              <svg class="mt-1 h-6 w-6 text-brand" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4h10l1 4H6l1-4zm-1 6h12l-1 10H7L6 10z"/></svg>
            {% endif %}
            <div class="flex-1">
              <div class="font-medium">{{ card.title }}</div>
              <p class="mt-1 text-sm text-gray-600">{{ card.note }}</p>
              <!-- Partner CTAs under each product (dummy links) -->
              <div class="mt-3 flex flex-wrap gap-2">
                <a href="#" class="inline-flex items-center rounded-lg bg-brand/10 px-3 py-1.5 text-sm font-medium text-brand hover:bg-brand/20">
                  Buy this routine
                </a>
                <a href="#" class="inline-flex items-center rounded-lg border px-3 py-1.5 text-sm font-medium hover:bg-gray-50">
                  Talk to a dermatologist
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div>
        <a href="{{ url_for('index') }}"
           class="inline-flex items-center rounded-xl bg-brand px-4 py-2 font-medium text-white hover:bg-brand-dark">
          Analyze another photo
        </a>
      </div>
    </div>
  </div>
</section>

{% endblock %}
